filesystem: "root"
mode: 0755
path: "/etc/NetworkManager/dispatcher.d/30-vip-prepender"
contents:
  inline: |
    #!/bin/bash
    IFACE=$1
    STATUS=$2
    # If $DHCP6_FQDN_FQDN contains a "-"
    [[ "$DHCP6_FQDN_FQDN" =~ - ]] && hostname $DHCP6_FQDN_FQDN
    case "$STATUS" in
        up|down|dhcp4-change|dhcp6-change)
        logger -s "NM virtual-ip-prepender triggered by ${1} ${2}."
        logger -s "NM DEBUG virtual-ip-prepender triggered by ${1} ${2}."
        logger -s "NM DEBUG virtual-ip-prepender env=$(env | tr '\n' ';')."
        logger -s "NM DEBUG virtual-ip-prepender BEFORE resolv.conf=$(cat /etc/resolv.conf | tr '\n' ' ')."
        logger -s "NM DEBUG virtual-ip-prepender BEFORE NM resolv.conf=$(cat /var/run/NetworkManager/resolv.conf | tr '\n' ' ')."
        VIRTUAL_IP="fd2e:6f44:5dd8:c956:0:0:0:2"
        set +e
        if [[ -n "$VIRTUAL_IP" ]]; then
            logger -s "NM virtual-ip-prepender: Prepending 'nameserver $VIRTUAL_IP' to other nameservers in /var/run/NetworkManager/resolv.conf"
            sed "/^search .*$/a nameserver $VIRTUAL_IP" /var/run/NetworkManager/resolv.conf > /etc/resolv.conf
        else
            logger -s "Couldn't find a Virtual IP, just updating resolv.conf"
            cp /var/run/NetworkManager/resolv.conf /etc/resolv.conf
        fi
        ;;
        *)
        ;;
    esac
