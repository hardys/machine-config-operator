filesystem: "root"
mode: 0755
path: "/etc/NetworkManager/dispatcher.d/30-vip-prepender"
contents:
  inline: |
    #!/bin/bash
    IFACE=$1
    STATUS=$2
    # If $DHCP6_FQDN_FQDN contains a "-"
    [[ "$DHCP6_FQDN_FQDN" =~ - ]] && hostname $DHCP6_FQDN_FQDN
    case "$STATUS" in
        up)
        logger -s "NM virtual-ip-prepender triggered by ${1} ${2}."
        VIRTUAL_IP="{{ .Infra.Status.PlatformStatus.BareMetal.NodeDNSIP }}"
        set +e
        if [[ -n $VIRTUAL_IP ]]; then
            logger -s "NM virtual-ip-prepender: Checking if worker virtual IP is the first entry in resolv.conf"
            if grep nameserver /etc/resolv.conf | head -n 1 | grep -q "$VIRTUAL_IP" ; then
                logger -s "NM virtual-ip-prepender: node virtual IP already is the first entry in resolv.conf"
                exit 0
            else
                logger -s "NM virtual-ip-prepender: Looking for 'search' in /etc/resolv.conf to place 'nameserver $VIRTUAL_IP'"
                sed -i "/^search .*$/a nameserver $VIRTUAL_IP" /etc/resolv.conf
            fi
        fi
        ;;
        *)
        ;;
    esac
